<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Stream Receiver</title>
    <style>
      video {
        width: 100%;
        max-width: 640px;
        height: auto;
        border: 1px solid #ccc;
      }
      button {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .status {
        margin-top: 10px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h2>Live Stream Receiver</h2>
    <video id="remoteVideo" autoplay playsinline></video>
    <div>
      <button id="scanButton" onclick="startScan()">
        Quét thiết bị Bluetooth
      </button>
      <button id="joinButton" onclick="sendRequest()" disabled>
        Yêu cầu stream
      </button>
      <button id="stopButton" onclick="cleanup()" disabled>Ngừng stream</button>
    </div>
    <div id="status" class="status">Đang kết nối đến server...</div>

    <script>
      const statusEl = document.getElementById("status");
      const joinButton = document.getElementById("joinButton");
      const stopButton = document.getElementById("stopButton");
      const remoteVideo = document.getElementById("remoteVideo");
      let pc = null;
      let bluetoothClient = null;
      let iceCandidatesQueue = [];
      let writeCharacteristic = null;

      function updateStatus(message) {
        statusEl.textContent = message;
        console.log(message);
      }

      // Quét thiết bị Bluetooth và kết nối với Raspberry Pi
      async function startScan() {
        try {
          updateStatus("Đang quét thiết bị Bluetooth...");
          // Quét các thiết bị Bluetooth có hỗ trợ dịch vụ mà chúng ta cần
          const device = await navigator.bluetooth.requestDevice({
            filters: [{ services: ["0000XXXX-0000-1000-8000-00805f9b34fb"] }], // UUID của dịch vụ Bluetooth cần tìm
          });

          updateStatus("Đã tìm thấy thiết bị: " + device.name);
          bluetoothClient = await device.gatt.connect();
          const service = await bluetoothClient.getPrimaryService(
            "0000XXXX-0000-1000-8000-00805f9b34fb"
          );
          writeCharacteristic = await service.getCharacteristic(
            "0000XXXX-0000-1000-8000-00805f9b34fb"
          );

          updateStatus("Đã kết nối đến thiết bị Bluetooth.");

          joinButton.disabled = false; // Kích hoạt nút yêu cầu stream
        } catch (error) {
          updateStatus("Lỗi khi quét thiết bị Bluetooth: " + error);
        }
      }

      async function createPeerConnection() {
        const configuration = {
          iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
        };
        pc = new RTCPeerConnection(configuration);

        pc.ontrack = (event) => {
          updateStatus("Đã nhận luồng video");
          remoteVideo.srcObject = event.streams[0];
          stopButton.disabled = false;
        };

        pc.onicecandidate = (event) => {
          if (event.candidate) {
            console.log("Tạo ICE candidate local");
            sendBluetoothMessage({
              type: "candidate",
              candidate: event.candidate,
            });
          }
        };

        pc.oniceconnectionstatechange = () => {
          updateStatus("Trạng thái ICE: " + pc.iceConnectionState);
          if (
            pc.iceConnectionState === "disconnected" ||
            pc.iceConnectionState === "failed" ||
            pc.iceConnectionState === "closed"
          ) {
            cleanup();
          }
        };
      }

      async function handleOffer(offer) {
        if (!pc) await createPeerConnection();

        updateStatus("Đang xử lý offer từ server");
        await pc.setRemoteDescription(new RTCSessionDescription(offer));
        while (iceCandidatesQueue.length > 0) {
          let candidate = iceCandidatesQueue.shift();
          await pc.addIceCandidate(new RTCIceCandidate(candidate));
          console.log("Đã thêm ICE candidate từ hàng đợi");
        }

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        sendBluetoothMessage({
          type: "answer",
          answer: {
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type,
          },
        });

        updateStatus("Đã gửi Answer đến server");
      }

      async function handleCandidate(candidate) {
        try {
          if (pc && pc.remoteDescription) {
            await pc.addIceCandidate(new RTCIceCandidate(candidate));
            console.log("Đã thêm ICE candidate từ server");
          } else {
            iceCandidatesQueue.push(candidate);
            console.log("Thêm ICE candidate vào hàng đợi");
          }
        } catch (error) {
          console.error("Lỗi khi thêm ICE candidate:", error);
        }
      }

      async function sendBluetoothMessage(message) {
        try {
          if (!writeCharacteristic) {
            throw new Error("Characteristic chưa được khởi tạo.");
          }

          const encoder = new TextEncoder();
          const data = encoder.encode(JSON.stringify(message));
          await writeCharacteristic.writeValue(data);
          console.log("Đã gửi tín hiệu:", message);
        } catch (error) {
          console.error("Lỗi khi gửi tín hiệu qua Bluetooth:", error);
        }
      }

      function sendRequest() {
        if (pc) {
          cleanup(false);
        }

        createPeerConnection().then(() => {
          updateStatus("Đang gửi yêu cầu join");
          joinButton.disabled = true;
          sendBluetoothMessage({ type: "join" });
        });
      }

      function cleanup(closeSocket = true) {
        updateStatus("Đang ngắt kết nối...");

        if (remoteVideo.srcObject) {
          remoteVideo.srcObject.getTracks().forEach((track) => track.stop());
          remoteVideo.srcObject = null;
        }

        if (pc) {
          pc.onicecandidate = null;
          pc.ontrack = null;
          pc.oniceconnectionstatechange = null;
          pc.close();
          pc = null;
        }

        if (bluetoothClient && closeSocket) {
          bluetoothClient.disconnect();
          bluetoothClient = null;
        }
      }

      // Lắng nghe sự kiện unload trang để làm sạch trước khi rời đi
      window.addEventListener("beforeunload", () => cleanup(true));
    </script>
  </body>
</html>
